<h1 style="text-align:center;">共享内存篇</h1>
<h2 style="text-align:center;">目录</h2>

- <strong>(一) </strong>[共享内存配置器](#share-memory-config)
- <strong>(二) </strong>[共享共享内存池管理器](#share-memory-pool-manager)

<h2 id="share-memory-config" style="text-align:center;">共享内存配置器</h2>
相关文件 :   

-   <strong>run/binconf/zone/data/inidata/memorypool.ini</strong>  
-   <strong>run/binconf/zone/data/inidata/memorypool.ini.tmpl</strong>  
-   <strong>src/base/memorypool/MemoryConfMgr.h</strong>  
-   <strong>src/base/memorypool/MemoryConfMgr.cpp</strong>  

memorypool.ini是由memorypool.ini.tmpl生成的, 这部分没用什么好说的, 具体可以去看脚本代码. memorypool.ini文件最终会被CMemoryConfig加载  
CMemoryConfig是一个简单的配置读取工具, 直接看代码 :  

![CMemoryConfMgr::InitByConfig](./picture/share_memory_config_init.png)


![CMemoryConfMgr::InitByConfig](./picture/share_memory_config_load_block.png)

这里比较核心的东西是加载各个进程的BaseKey, BlockSize等一系列东西, 主要分为以下几个步骤 :   
- 1.加载配置中的进程名称, 即memorypool.ini中的`ProcessList`变量
- 2.根据`ProcessList`中的进程名动态加载对应共享内存配置, 例如`[zone]`
- 3.计算每个`ShmKey`的所属进程, 如果出现多个进程同时引用同一`ShmKey`的情况, 则起服失败
- 4.保存自己进程的共享内存配置, 若开启共享内存分配新策略, 则初始化`CMemoryPoolMgr`

<h2 id="share-memory-pool-manager" style="text-align:center;">共享内存池管理器</h2>